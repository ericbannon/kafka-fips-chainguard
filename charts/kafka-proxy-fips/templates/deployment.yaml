{{- range $i, $e := until (.Values.proxy.replicaCount | int) }}
{{- $broker := index $.Values.proxy.brokers $i }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-proxy-{{ $i }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app.kubernetes.io/name: kafka-proxy
    app.kubernetes.io/instance: {{ $.Release.Name | quote }}
    app.kubernetes.io/component: proxy
    kafka-proxy/ordinal: {{ $i | quote }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kafka-proxy
      app.kubernetes.io/instance: {{ $.Release.Name | quote }}
      app.kubernetes.io/component: proxy
      kafka-proxy/ordinal: {{ $i | quote }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kafka-proxy
        app.kubernetes.io/instance: {{ $.Release.Name | quote }}
        app.kubernetes.io/component: proxy
        kafka-proxy/ordinal: {{ $i | quote }}
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
      containers:
        - name: kafka-proxy
          image: "{{ $.Values.proxy.image.registry }}/{{ $.Values.proxy.image.repository }}:{{ $.Values.proxy.image.tag }}"
          imagePullPolicy: {{ $.Values.proxy.image.pullPolicy }}
          args:
            - server
            - --dynamic-listeners-disable

            # Listen locally and advertise the per-proxy Service name.
            #
            # LEFT side MUST match what Kafka clients will see in metadata for brokers.
            # That is almost always the CLIENT listener (9092), not the interbroker port.
            - --bootstrap-server-mapping
            - {{ $broker.host }}:{{ $broker.port }},0.0.0.0:{{ $.Values.proxy.service.kafkaPort }},kafka-proxy-{{ $i }}.{{ $.Release.Namespace }}.svc.{{ $.Values.clusterDomain }}:{{ $.Values.proxy.service.kafkaPort }}

            # Dial mappings: where the proxy actually connects upstream.
            # Include ALL brokers so any proxy can connect to any broker as needed.
            {{- range $j, $b := $.Values.proxy.brokers }}
            - --dial-address-mapping
            - {{ $b.host }}:{{ $b.port }},{{ $b.host }}:{{ $b.port }}
            {{- end }}

            # Rewrite broker addresses in metadata to point at proxies.
            # Again: LEFT side MUST match the broker addresses/ports returned in metadata (CLIENT listener).
            {{- range $j, $b := $.Values.proxy.brokers }}
            - --external-server-mapping
            - {{ $b.host }}:{{ $b.port }},kafka-proxy-{{ $j }}.{{ $.Release.Namespace }}.svc.{{ $.Values.clusterDomain }}:{{ $.Values.proxy.service.kafkaPort }}
            {{- end }}

            - --http-listen-address
            - 0.0.0.0:{{ $.Values.proxy.service.httpPort }}

            # mTLS on the proxy listener (client -> proxy)
            - --proxy-listener-tls-enable
            - --proxy-listener-cert-file
            - /tls/tls.crt
            - --proxy-listener-key-file
            - /tls/tls.key
            - --proxy-listener-ca-chain-cert-file
            - /tls/ca.crt

            # mTLS when dialing upstream brokers (proxy -> broker)
            - --tls-enable
            - --tls-ca-chain-cert-file
            - /tls/ca.crt
            - --tls-client-cert-file
            - /tls/tls.crt
            - --tls-client-key-file
            - /tls/tls.key

            - --log-level
            - {{ $.Values.proxy.logLevel | default "info" }}
          ports:
            - name: kafka-mtls
              containerPort: {{ $.Values.proxy.service.kafkaPort }}
            - name: http
              containerPort: {{ $.Values.proxy.service.httpPort }}
          resources:
            {{- toYaml $.Values.proxy.resources | nindent 12 }}
          volumeMounts:
            - name: mtls
              mountPath: /tls
              readOnly: true
          readinessProbe:
            tcpSocket:
              port: kafka-mtls
            initialDelaySeconds: 3
            periodSeconds: 5
            failureThreshold: 12
          livenessProbe:
            tcpSocket:
              port: kafka-mtls
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 6
      volumes:
        - name: mtls
          secret:
            secretName: {{ $.Values.proxy.tlsSecretName }}
{{- end }}